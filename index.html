<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inicio - IBEC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; background-color: #2c3e50; color: white; }
        .sidebar .nav-link { color: #bdc3c7; }
        .sidebar .nav-link:hover { background-color: #34495e; }
        .sidebar .nav-link.active { background-color: #3498db; color: white; }
        .main-content { padding: 20px; }
        .card { transition: transform 0.2s; border: none; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .footer { margin-top: 50px; color: #95a5a6; font-size: 0.9em; }
        .role-badge { font-size: 0.8em; padding: 0.5em 0.8em; }
        .bg-admin { background-color: #e74c3c; }
        .bg-academico { background-color: #3498db; }
        .bg-profesor { background-color: #f39c12; }
        .bg-estudiante { background-color: #27ae60; }
        #mensaje-bienvenida { margin-bottom: 20px; }
    </style>
</head>
<body>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <div class="row">
            <!-- Menú Lateral -->
            <nav id="sidebar" class="col-md-3 col-lg-2 sidebar">
                <div class="position-sticky pt-3">
                    <h5 class="text-white text-center py-3 border-bottom">IBEC</h5>
                    <ul id="menu-dinamico" class="nav flex-column">
                        <!-- Se llenará con JavaScript -->
                    </ul>
                </div>
            </nav>

            <!-- Contenido Principal -->
            <main id="main-content" class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <!-- Mensaje de bienvenida o error -->
                <div id="mensaje-bienvenida"></div>

                <!-- Contenido dinámico -->
                <div id="contenido-dinamico">
                    <p class="text-muted">Cargando información del usuario...</p>
                </div>

                <!-- Pie de página -->
                <div class="footer text-center mt-5">
                    <p>© 2025 Instituto Bíblico El Camino (IBEC) — Sistema de Gestión Académica</p>
                </div>
            </main>
        </div>
    </div>

    <!-- ✅ Firebase SDK (SIN ESPACIOS) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <!-- ✅ CONFIGURACIÓN DE FIREBASE — PEGA AQUÍ TUS DATOS REALES -->
    <script>
        // ⚠️ ⚠️ ⚠️ PEGA TU CONFIGURACIÓN REAL DESDE FIREBASE CONSOLE AQUÍ ⚠️ ⚠️ ⚠️
        const firebaseConfig = {
           apiKey: "AIzaSyCV_UwzE7uPv67-3iR2Arv71fOL6fd1wdw",
          authDomain: "ibec-login.firebaseapp.com",
          projectId: "ibec-login",
          storageBucket: "ibec-login.firebasestorage.app",
          messagingSenderId: "616348709046",
          appId: "1:616348709046:web:07e77e7e2fba90a0b57617",
          measurementId: "G-0R13GPY97Z"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <!-- ✅ Script principal del dashboard -->
    <script>
        // Verificar autenticación al cargar
        auth.onAuthStateChanged(async function(user) {
            if (!user) {
                // Redirigir al login si no hay sesión
                window.location.href = "index.html";
                return;
            }

            try {
                // Obtener datos del usuario desde Firestore
                const userDoc = await db.collection("usuarios").doc(user.uid).get();
                if (!userDoc.exists) {
                    document.getElementById('mensaje-bienvenida').innerHTML = 
                        '<div class="alert alert-danger">⚠️ Usuario no encontrado en la base de datos. Contacta al administrador.</div>';
                    return;
                }

                const userData = userDoc.data();
                const rol = userData.rol || 'invitado';
                const nombres = userData.nombres || 'Usuario';
                const apellidos = userData.apellidos || '';
                const codigo = userData.codigo_estudiante || null;

                // Mostrar mensaje de bienvenida
                document.getElementById('mensaje-bienvenida').innerHTML = 
                    `<div class="alert alert-success">✅ ¡Bienvenido, <strong>${nombres} ${apellidos}</strong>!</div>`;

                // Generar menú y contenido
                generarMenu(rol);
                generarContenido(rol, nombres, apellidos, codigo);

            } catch (error) {
                console.error("Error al cargar datos:", error);
                document.getElementById('mensaje-bienvenida').innerHTML = 
                    '<div class="alert alert-danger">❌ Error al cargar tus datos. Recarga la página o intenta más tarde.</div>';
            }
        });

        function generarMenu(rol) {
            const menu = document.getElementById('menu-dinamico');
            let html = `
                <li class="nav-item">
                    <a class="nav-link active" href="dashboard.html">
                        <i class="bi bi-house-door"></i> Inicio
                    </a>
                </li>
            `;

            if (rol === 'admin' || rol === 'admin_academico') {
                html += `
                    <li class="nav-item">
                        <a class="nav-link" href="admin/academico/inicio.html">
                            <i class="bi bi-journal-text"></i> Gestión Académica
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="admin/usuarios/gestionar.html">
                            <i class="bi bi-people"></i> Gestión de Usuarios
                        </a>
                    </li>
                `;
            }

            if (rol === 'profesor') {
                html += `
                    <li class="nav-item">
                        <a class="nav-link" href="profesor/grupos.html">
                            <i class="bi bi-people-fill"></i> Mis Grupos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profesor/asistencias.html">
                            <i class="bi bi-check-circle"></i> Tomar Asistencias
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profesor/notas.html">
                            <i class="bi bi-clipboard2-check"></i> Ingresar Notas
                        </a>
                    </li>
                `;
            }

            if (rol === 'estudiante') {
                html += `
                    <li class="nav-item">
                        <a class="nav-link" href="estudiante/historial.html">
                            <i class="bi bi-journal-medical"></i> Mi Historial Académico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="estudiante/certificados.html">
                            <i class="bi bi-award"></i> Mis Certificados
                        </a>
                    </li>
                `;
            }

            // Cerrar sesión
            html += `
                <li class="nav-item mt-auto">
                    <a class="nav-link text-danger" href="logout.html">
                        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                    </a>
                </li>
            `;

            menu.innerHTML = html;
        }

        function generarContenido(rol, nombres, apellidos, codigo) {
            let contenido = `
                <div class="d-flex justify-content-between flex-wrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1>Bienvenido al Sistema IBEC</h1>
                    <div class="text-end">
                        <span class="d-block text-muted">Sesión activa como:</span>
                        <strong>${nombres} ${apellidos}</strong>
                        <span class="badge role-badge 
                            ${getBadgeClass(rol)} 
                            text-white ms-2">
                            ${formatRol(rol)}
                        </span>
                    </div>
                </div>

                <!-- Información del usuario -->
                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5><i class="bi bi-person-badge"></i> Información del Usuario</h5>
                                <div class="row">
                                    <div class="col-md-4"><strong>Nombre:</strong> ${nombres} ${apellidos}</div>
                                    <div class="col-md-4"><strong>Rol:</strong> ${formatRolCompleto(rol)}</div>
                                    ${codigo ? `<div class="col-md-4"><strong>Código Estudiante:</strong> ${codigo}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Accesos rápidos por rol
            contenido += '<div class="row g-4">';

            if (rol === 'admin' || rol === 'admin_academico') {
                contenido += `
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-journal-text"></i> Gestión Académica</h5>
                                <p class="card-text">Administra carreras, asignaturas, ciclos, grupos y matrículas.</p>
                                <a href="admin/academico/inicio.html" class="btn btn-primary">Ir a Académico</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-people"></i> Gestión de Usuarios</h5>
                                <p class="card-text">Crea y administra estudiantes, profesores y administradores.</p>
                                <a href="admin/usuarios/gestionar.html" class="btn btn-success">Gestionar Usuarios</a>
                            </div>
                        </div>
                    </div>
                `;
            } else if (rol === 'profesor') {
                contenido += `
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-people-fill"></i> Mis Grupos</h5>
                                <p class="card-text">Consulta los grupos que te han sido asignados.</p>
                                <a href="profesor/grupos.html" class="btn btn-info">Ver Grupos</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-clipboard2-check"></i> Ingreso de Notas</h5>
                                <p class="card-text">Registra calificaciones de tareas, exámenes y asistencia.</p>
                                <a href="profesor/notas.html" class="btn btn-warning">Ingresar Notas</a>
                            </div>
                        </div>
                    </div>
                `;
            } else if (rol === 'estudiante') {
                contenido += `
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-journal-medical"></i> Historial Académico</h5>
                                <p class="card-text">Consulta tus asignaturas, notas y promedio general (CUM).</p>
                                <a href="estudiante/historial.html" class="btn btn-success">Ver Historial</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-award"></i> Mis Certificados</h5>
                                <p class="card-text">Descarga los certificados que has obtenido.</p>
                                <a href="estudiante/certificados.html" class="btn btn-primary">Ver Certificados</a>
                            </div>
                        </div>
                    </div>
                `;
            }

            contenido += '</div>';
            document.getElementById('contenido-dinamico').innerHTML = contenido;
        }

        function getBadgeClass(rol) {
            switch(rol) {
                case 'admin': return 'bg-admin';
                case 'admin_academico': return 'bg-academico';
                case 'profesor': return 'bg-profesor';
                case 'estudiante': return 'bg-estudiante';
                default: return 'bg-secondary';
            }
        }

        function formatRol(rol) {
            if (rol === 'admin') return 'Admin';
            return rol.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatRolCompleto(rol) {
            if (rol === 'admin') return 'Administrador';
            if (rol === 'admin_academico') return 'Administración Académica';
            return rol.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
    </script>

</body>
</html>
