<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Estudiantil - IBEC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; background-color: #2c3e50; color: white; }
        .sidebar .nav-link { color: #bdc3c7; }
        .sidebar .nav-link:hover { background-color: #34495e; }
        .sidebar .nav-link.active { background-color: #3498db; color: white; border-radius: 8px; margin: 0 10px; }
        .main-content { padding: 20px; }
        .footer { margin-top: 50px; color: #95a5a6; font-size: 0.9em; }
        .card-quick { 
            transition: transform 0.2s, box-shadow 0.2s; 
            cursor: pointer; 
            height: 100%; 
            border: none; 
            border-radius: 12px;
        }
        .card-quick:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); 
        }
        .card-quick .card-body { 
            text-align: center; 
            padding: 25px 15px; 
        }
        .card-quick i { 
            font-size: 2.5rem; 
            margin-bottom: 15px; 
        }
        #mensaje-verificacion { margin-bottom: 20px; }
    </style>
</head>
<body>

    <!-- Contenedor principal -->
    <div class="container-fluid">
        <div class="row">
            <!-- Menú Lateral -->
            <nav id="sidebar" class="col-md-3 col-lg-2 sidebar">
                <div class="position-sticky pt-3">
                    <h5 class="text-white text-center py-3 border-bottom">IBEC</h5>
                    <ul id="menu-dinamico" class="nav flex-column">
                        <!-- Se llenará con JavaScript -->
                    </ul>
                </div>
            </nav>

            <!-- Contenido Principal -->
            <main id="main-content" class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <!-- Mensaje de verificación -->
                <div id="mensaje-verificacion"></div>

                <!-- Contenido dinámico -->
                <div id="contenido-dinamico">
                    <p class="text-muted">Verificando sesión...</p>
                </div>

                <!-- Pie de página -->
                <div class="footer text-center mt-5">
                    <p>© 2025 Instituto Bíblico El Camino (IBEC) — Sistema de Gestión Académica</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <!-- Configuración de Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCV_UwzE7uPv67-3iR2Arv71fOL6fd1wdw",
            authDomain: "ibec-login.firebaseapp.com",
            projectId: "ibec-login",
            storageBucket: "ibec-login.firebasestorage.app",
            messagingSenderId: "616348709046",
            appId: "1:616348709046:web:07e77e7e2fba90a0b57617",
            measurementId: "G-0R13GPY97Z"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <!-- Script principal -->
    <script>
        // Verificar autenticación y rol al cargar
        auth.onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = "../login.html";
                return;
            }

            try {
                const userDoc = await db.collection("usuarios").doc(user.uid).get();
                if (!userDoc.exists) {
                    document.getElementById('mensaje-verificacion').innerHTML = 
                        '<div class="alert alert-danger">Usuario no encontrado en la base de datos.</div>';
                    return;
                }

                const userData = userDoc.data();
                const rol = userData.rol || 'invitado';

                // Verificar que es estudiante
                if (rol !== 'estudiante') {
                    document.getElementById('mensaje-verificacion').innerHTML = 
                        '<div class="alert alert-warning">No tienes permiso para acceder a esta sección.</div>';
                    setTimeout(() => {
                        window.location.href = "../dashboard.html";
                    }, 3000);
                    return;
                }

                const nombres = userData.nombres || 'Usuario';
                const apellidos = userData.apellidos || '';
                const codigo = userData.codigo_estudiante || 'No asignado';
                const nombreCompleto = (nombres + ' ' + apellidos).trim();

                // Mostrar mensaje de bienvenida
                document.getElementById('mensaje-verificacion').innerHTML = 
                    `<div class="alert alert-success">✅ Sesión iniciada como estudiante</div>`;

                // Generar menú y contenido
                generarMenu();
                generarContenido(nombreCompleto, codigo);

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('mensaje-verificacion').innerHTML = 
                    '<div class="alert alert-danger">Error al cargar la página. Intenta nuevamente.</div>';
            }
        });

        function generarMenu() {
            const menu = document.getElementById('menu-dinamico');
            let html = `
                <li class="nav-item">
                    <a class="nav-link active" href="inicio.html">
                        <i class="bi bi-house-door"></i> Inicio
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="historial.html">
                        <i class="bi bi-journal-medical"></i> Mi Historial Académico
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="certificados.html">
                        <i class="bi bi-award"></i> Mis Certificados
                    </a>
                </li>
                <li class="nav-item mt-auto">
                    <a class="nav-link text-danger" href="../logout.html">
                        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                    </a>
                </li>
            `;
            menu.innerHTML = html;
        }

        function generarContenido(nombreCompleto, codigo) {
            let contenido = `
                <!-- Título y sesión en una sola línea -->
                <div class="row g-4 mb-4">
                    <!-- Sección de Título -->
                    <div class="col-md-7">
                        <div class="card bg-primary text-white h-100" style="border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <div class="card-body d-flex align-items-center">
                                <div>
                                    <h2 class="mb-1"><i class="bi bi-journal-code"></i> Bienvenido al Sistema IBEC</h2>
                                    <p class="mb-0 opacity-75">Gestión Académica - Instituto Bíblico El Camino</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Sesión Iniciada -->
                    <div class="col-md-5">
                        <div class="card bg-light h-100" style="border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <div class="card-body">
                                <h5 class="text-center mb-3"><i class="bi bi-person-check text-success"></i> Sesión Iniciada</h5>
                                <div class="text-center">
                                    <p class="mb-1"><strong>${nombreCompleto}</strong></p>
                                    <p class="mb-0 text-muted small">
                                        <i class="bi bi-shield-check"></i> 
                                        Estudiante
                                    </p>
                                    <p class="mb-0 text-muted small">
                                        <i class="bi bi-upc"></i> 
                                        Código: ${codigo}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuadritos de acceso rápido -->
                <div class="row g-4 justify-content-center">
                    <div class="col-md-6 col-lg-4">
                        <a href="historial.html" class="text-decoration-none">
                            <div class="card card-quick bg-info text-white">
                                <div class="card-body">
                                    <i class="bi bi-journal-medical"></i>
                                    <h5>Mi Historial Académico</h5>
                                    <p>Consulta tus asignaturas, notas y promedio general (CUM)</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <a href="certificados.html" class="text-decoration-none">
                            <div class="card card-quick bg-warning text-dark">
                                <div class="card-body">
                                    <i class="bi bi-award"></i>
                                    <h5>Mis Certificados</h5>
                                    <p>Descarga los certificados que has obtenido</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('contenido-dinamico').innerHTML = contenido;
        }
    </script>

</body>
</html>
